name: Publish to npm

on:
    workflow_dispatch:
        inputs:
            package:
                description: 'Package to publish'
                required: true
                type: choice
                options:
                    - all
                    - elasticsearch-plugin
                    - payments-plugin
                    - sentry-plugin
                    - stellate-plugin
                    - pub-sub-plugin
            dist-tag:
                description: 'npm dist-tag'
                required: true
                type: choice
                options:
                    - latest
                    - next
                    - dev
                default: 'latest'
            dry-run:
                description: 'Dry run (no actual publish)'
                required: false
                type: boolean
                default: false

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  registry-url: 'https://registry.npmjs.org'
            - run: npm ci
            - run: npm run build

            # For pre-releases: auto-bump to timestamped pre-release versions in CI.
            # These version changes are ephemeral â€” they are NOT committed back to the repo.
            - name: Bump pre-release versions
              if: inputs.dist-tag != 'latest'
              run: |
                  DATE=$(date +'%Y%m%d%H%M')
                  TAG="${{ inputs.dist-tag }}"
                  if [ "${{ inputs.package }}" = "all" ]; then
                    SCOPE="--no-private"
                  else
                    SCOPE="--scope @vendure-community/${{ inputs.package }}"
                  fi
                  export TAG DATE
                  npx lerna exec $SCOPE -- \
                    'NEW=$(node -p "const v=require(\"./package.json\").version.replace(/-.*/,\"\").split(\".\");v[2]++;v.join(\".\")") && \
                     npm version "${NEW}-${TAG}.${DATE}" --no-git-tag-version'

            # Publish: single package or pre-release (all packages)
            - name: Publish package(s)
              if: inputs.package != 'all' || inputs.dist-tag != 'latest'
              run: |
                  if [ "${{ inputs.package }}" = "all" ]; then
                    SCOPE="--no-private"
                  else
                    SCOPE="--scope @vendure-community/${{ inputs.package }}"
                  fi
                  ARGS="--access public --tag ${{ inputs.dist-tag }}"
                  if [ "${{ inputs.dry-run }}" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                  fi
                  npx lerna exec $SCOPE -- npm publish $ARGS
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            # Publish: all packages, stable release.
            # Uses lerna publish from-package which compares local versions to the npm
            # registry and only publishes packages with unpublished versions.
            - name: Publish all changed packages (stable)
              if: inputs.package == 'all' && inputs.dist-tag == 'latest'
              run: |
                  ARGS="--yes"
                  if [ "${{ inputs.dry-run }}" = "true" ]; then
                    echo "=== DRY RUN ==="
                    npx lerna changed || echo "No changed packages found"
                    exit 0
                  fi
                  npx lerna publish from-package $ARGS
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
