name: Build & Test

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [20.x, 22.x]
        services:
            elasticsearch:
                image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
                env:
                    discovery.type: single-node
                    bootstrap.memory_lock: 'true'
                    ES_JAVA_OPTS: '-Xms512m -Xmx512m'
                ports:
                    - 9200:9200
                options: >-
                    --health-cmd "curl -s http://localhost:9200/_cluster/health | grep -vq '\"status\":\"red\"'"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 10
            redis:
                image: redis:7.2-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
            - run: npm ci
            - run: npm run build
            - name: Run unit tests
              run: npm run test
            - name: Run e2e tests
              run: npm run e2e
              env:
                  CI: true
